<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Informasi Karyawan</title>
  <link rel="icon" type="image/x-icon" href="./assets/images/logoinovasi.png">
  <link rel="stylesheet" href="assets/dashboard.css">
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    table thead {
      background-color: #005f73;
      color: #ffffff;
    }

    table th, table td {
      border: 1px solid #ddd;
      text-align: left;
      padding: 8px;
    }

    table tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    table tbody tr:hover {
      background-color: #d3d3d3;
    }

    .struktur-organisasi {
      overflow-x: auto;
    }

    .struktur-organisasi table {
      font-size: 0.9rem;
    }

    .struktur-gambar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
    }

    .struktur-gambar h2 {
      color: #425C5A;
      font-family: 'Times New Roman', Times, serif;
      font-size: 1.5rem;
      margin-bottom: 10px;
    }

    .struktur-gambar img {
      max-width: 40%;
      height: auto;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .edit-button {
      background-color: #4C9F98;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
    }

    .edit-button:hover {
      background-color: #3A8078;
    }
  </style>
</head>
<body>

        <!-- Navbar -->
      <nav class="navbar">
          <div class="navbar-logo">
              <img src="assets/images/logoinovasi.png" alt="Logo Inovasi Digital">
              <div class="navbar-title">
                  <h3>SISTEM INFORMASI</h3>
                  <h3>KARYAWAN</h3>
                  <h3>INOVASI DIGITAL</h3>
              </div>
          </div>
          <div class="navbar-menu">
              <a href="dashboard.html" class="navbar-item">Dashboard</a>
              <a href="datamaster.html" class="navbar-item">Data Master</a>
              <a href="datastaff.html" class="navbar-item">Data Staff</a>
              <a href="datahuka.html" class="navbar-item">Data Hubungan Kerja</a>
              <a href="datacuti.html" class="navbar-item">Data Cuti</a>
          </div>
          <div class="navbar-user">
            <img src="assets/images/logout (1).png" alt="User Icon" class="user-icon" id="userDropdownBtn">
            <div class="dropdown-menu" id="userDropdown">
              <a href="#" class="dropdown-item" id="logoutBtn">
                <img src="assets/images/logout.png" alt="Logout Icon" class="dropdown-icon">
                Logout
              </a>
            </div>
          </div>
      </nav>

  <!-- Hamburger untuk mobile -->
  <div class="hamburger" onclick="toggleSidebar()">
    <div></div>
    <div></div>
    <div></div>
  </div>

  <!-- Sidebar untuk mobile -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <img src="assets/images/logoinovasi.png" alt="Logo Inovasi Digital">
      <h3>SISTEM INFORMASI</h3>
      <h3>KARYAWAN</h3>
      <h3>INOVASI DIGITAL</h3>
    </div>
    <a href="dashboard.html" class="sidebar-item">Dashboard</a>
    <a href="datamaster.html" class="sidebar-item">Data Master</a>
    <a href="datastaff.html" class="sidebar-item">Data Staff</a>
    <a href="datahuka.html" class="sidebar-item">Data Hubungan Kerja</a>
    <a href="datacuti.html" class="sidebar-item">Data Cuti</a>
    <div class="sidebar-logout">
      <a href="#" class="logout-link" id="logoutBtnSidebar">
        <img src="assets/images/logout.png" class="dropdown-icon"> Logout
      </a>
    </div>
  </div>

  <div class="container">
    <main class="dashboard">
      <header>
        <h1>
          Database HR
          <a href="datamaster.html" style="text-decoration: none; color: inherit;">/ Data Master</a>
          <a href="struktur.html" style="text-decoration: none; color: #4C9F98;">/ Struktur Organisasi</a>
        </h1>        
      </header>

      <div class="struktur-gambar">
        <img id="struktur-image" alt="Struktur Organisasi">
        <button class="edit-button" onclick="editGambar()">Edit Gambar</button>
      </div>

      <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
        <button id="addUnitButton" class="btn btn-primary">Tambah Unit</button>
      </div>      

      <div class="struktur-organisasi">
        <table id="struktur-table">
          <thead>
            <tr>
              <th>ID Unit</th>
              <th>Nama Unit</th>
              <th>Nama Departemen</th>
              <th>Aksi</th>
              <th>Aksi Lainnya (Unit)</th>
              <th>Aksi Khusus Departemen</th>
            </tr>
          </thead>
          <tbody id="struktur-body">
          </tbody>
        </table>
      </div>
    </main>
  </div>

  <!-- Menambahkan Supabase dan memastikan koneksi terdefinisi -->
  <script type="module">
    import { supabase } from './assets/supabase.js';

    async function editGambar() {
      console.log("Fungsi editGambar dipanggil.");
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'image/*';

      fileInput.onchange = async (event) => {
        const file = event.target.files[0];
        console.log("File yang dipilih:", file);

        if (file) {
          // Mengunggah gambar ke Supabase Storage
          const { data, error } = await supabase.storage
            .from('assets')
            .upload(`images/struktur-${Date.now()}.png`, file, {
              cacheControl: '3600',
              upsert: false,
            });

          if (error) {
            console.error("Gagal mengunggah file:", error);
            alert('Gagal mengunggah gambar.');
            return;
          }

          console.log("File berhasil diunggah:", data);

          const { data: publicData, error: publicError } = supabase.storage
            .from('assets')
            .getPublicUrl(data.path);

          if (publicError) {
            console.error("Gagal mendapatkan URL publik:", publicError);
            alert('Gagal mendapatkan URL publik.');
            return;
          }

          console.log("URL publik gambar:", publicData.publicUrl);
          document.getElementById('struktur-image').src = publicData.publicUrl;

          // Menyimpan URL ke database secara otomatis
          const { error: dbError } = await supabase
            .from('struktur_gambar')
            .upsert([
              { url_gambar: publicData.publicUrl }
            ]);

          if (dbError) {
            console.error("Gagal menyimpan URL ke database:", dbError);
            alert('Gagal menyimpan URL gambar ke database.');
          }
        }
      };

      fileInput.click();
    }

    async function getGambarStruktur() {
      const { data, error } = await supabase
        .from('struktur_gambar')
        .select('url_gambar')
        .single();

      if (error) {
        console.error("Gagal mengambil URL gambar:", error);
        return;
      }

      if (data && data.url_gambar) {
        document.getElementById('struktur-image').src = data.url_gambar;
      } else {
        document.getElementById('struktur-image').src = 'path_to_default_image.png';
      }
    }

    document.addEventListener('DOMContentLoaded', getGambarStruktur);
    window.editGambar = editGambar;
  </script>

  <script>
    // Sidebar
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('active');
    }

    // Dropdown User
    const userBtn = document.getElementById('userDropdownBtn');
    const dropdown = document.getElementById('userDropdown');

    userBtn.addEventListener('click', () => {
      dropdown.style.display = (dropdown.style.display === 'block') ? 'none' : 'block';
    });

    document.addEventListener('click', function(event) {
      if (!userBtn.contains(event.target) && !dropdown.contains(event.target)) {
        dropdown.style.display = 'none';
      }
    });

    // Logout Function
    function handleLogout() {
      alert("Logout berhasil!");
      window.location.href = "index.html";
    }

    document.getElementById('logoutBtn')?.addEventListener('click', handleLogout);
    document.getElementById('logoutBtnSidebar')?.addEventListener('click', handleLogout);
  </script>

  <script src="assets/navbar.js"></script>
  <script type="module" src="assets/struktur.js"></script>
  <script type="module" src="assets/supabase.js"></script>
  <script type="module" src="assets/addUnit.js"></script>
</body>
</html>
